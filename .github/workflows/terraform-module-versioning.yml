name: Terraform Module Versioning

on:
  push:
    branches:
      - main
    paths:
      - "gcp/**/*"

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Check changes in modules
        run: |
          git diff --name-only HEAD^ HEAD | grep -E "gcp/cloud-cloudbuild-trigger/|gcp/cloud-function-v1/|gcp/cloud-run-v1/" && echo "MODULE_CHANGED=true" >> $GITHUB_ENV || echo "No module changes detected"

      - name: Create new version tag
        if: env.MODULE_CHANGED == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Example logic to increment the patch version using Semantic Versioning
          LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
          NEW_TAG=$(echo $LATEST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "Creating new tag: $NEW_TAG"
          
          git tag $NEW_TAG
          git push origin $NEW_TAG
